= WebSocket Connector Configuration - Mule 4
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../../assets/images/

When you configure Anypoint Connector for WebSockets (WebSocket Connector), you can do any of the following:

* <<server-configuration,Configure a WebSocket server>>
* <<client-configuration,Configure a WebSocket client>>
* <<combined-configuration>,Configure a WebSocket server and client>>

== WebSocket Server Configuration [[server-configuration]]

If your app exposes a WebSocket inbound endpoint, use the `<ws:server-settings>` element to configure that endpoint. Because an app uses an HTTP request to initiate WebSocket connections, exposing a WebSocket inbound endpoint requires pointing to an underlying HTTP Listener configuration. This configuration enables the app to:

* Reuse the available settings of an HTTP Listener, such as the settings for host, port, TLS, and so forth.
* Expose both WebSockets and regular HTTP endpoints on the same port.

When you configure the HTTP Listener, you can specify base connection settings such as settings for the host, port, and base path. Alternatively, you can configure a TLS-based connection (WSS), as described in <xxx>.

== Sample WebSocket Server Configuration

The following XML code shows a sample WebSocket server configuration.

[source,xml,linenums]
----
<http:listener-config name="httpListenerConfig" basePath="/regularHttp">
   <http:listener-connection host="0.0.0.0" port="80" />
</http:listener-config>

<websocket:config ​name​=​"wsServer"​> ​
    <websocket:connection>
    ​   <websocket:server-settings ​listenerConfig​=​"httpListenerConfig" listenerBasePath​=​"/ws"​/>
    </websocket:connection>
</websocket:config>

<flow name="chat">
    <websocket:inbound-listener path="/chat" config-ref="wsServer"/>
    <logger level="INFO" message="A new message has been received! #[payload]"/>
</flow>
----

In this example, the app listens for incoming messages at +`ws://localhost:80/ws/chat`:

* The `listenerConfig` attribute` points to the HTTP Listener configuration named `httpListenerConfig`, which listens for incoming messages on localhost (0.0.0.0) and port 80.
* The `listenerBasePath` attribute value `/ws` overrides the HTTP Listener `basePath` attribute value.
* The `path` attribute value `/chat` specifies the path.

Because the HTTP Listener does not reference a TLS Configuration component, the connection uses the WS protocol by default.

==== Server Timeouts

Because WebSocket connections are persistent and stateful, it's a good practice to set a timeout to automatically close idle connections. By default, all inbound WebSockets have an idle timeout of 15 minutes.

The following example shows how to use the `<websocket:server-settings>` element to configure a one hour idle sockets timeout:

[source,xml,linenums]
----
<http:listener-config name="httpListenerConfig" basePath="/regularHttp">
   <http:listener-connection host="0.0.0.0" port="80" />
</http:listener-config>

<websocket:config ​name​=​"wsServer"​> ​
    <websocket:connection>
    ​   <websocket:server-settings ​listenerConfig​=​"httpListenerConfig" listenerBasePath​=​"/ws"​/ idleSocketTimeout="1" idleSocketTimeoutUnit="HOUR">
    </websocket:connection>
</websocket:config>
----

== WebSocket Client Configuration [[client-configuration]]

If your app needs to connect to external WebSocket services, configure the `websocket:client-settings` element.



In this example:

* The configuration for the outbound WebSocket references the WebSocket client configuration `wsClient` in the `config-ref` attribute. (In this example, you don't need to reference an HTTP Configuration.)

we chose to specify a host, port and basePath to build our WS request URI. The host parameter is optional, if not set it will be set to "localhost". The port parameter is optional, if not specified the default value will be set according to the protocol scheme, if WS is used the default value will be set to 80, if WSS is used the default will be set to 443. The basePath parameter is optional, if URI is not set it will indicate the base path for all client requests relative to the indicated host and port, if not set the default value will be set to "/".

/// Is there ever a need to reference an HTTP configuration for an Outbound WebSocket?
///

[source,xml,linenums]
----
<websocket:config ​name​=​"wsClient"​> ​
    <websocket:connection>
    ​   <websocket:client-settings ​host​=​"localhost" port​=​"80"​ ​basePath​=​"/ws"​ />
    </websocket:connection>
</websocket:config>

<flow="connectToWebSocketFlow">
    <websocket:open-outbound-socket path="/chat" socketId="myCustomWebSocketID-123" config-ref="wsClient" />
    </websocket:open-outbound-socket>

    <logger info="INFO" message="Opened connection to external service!"/>
</flow>
----

In this example we have initialized an Outbound Socket which references the WebSocket client configuration("wsClient") in the config-ref attribute. In this case, there is no need to reference an HTTP Configuration.

In the configuration above, we chose to specify a host, port and basePath to build our WS request URI. The host parameter is optional, if not set it will be set to "localhost". The port parameter is optional, if not specified the default value will be set according to the protocol scheme, if WS is used the default value will be set to 80, if WSS is used the default will be set to 443. The basePath parameter is optional, if URI is not set it will indicate the base path for all client requests relative to the indicated host and port, if not set the default value will be set to "/".

You can also specify a URL.

[source,xml,linenums]
----
<websocket:config ​name​=​"wsClient"​> ​
    <websocket:connection>
    ​   <websocket:client-settings ​uri="ws://www.mulesoft.com"​ />
    </websocket:connection>
</websocket:config>
----

However, in this case we cannot indicate a path because the URL and Path parameters are mutually exclusive, this is because URL will indicate a full resource locator, while the Path will indicate a path relative to the host, port and basePath.

==== Default Parameters and Headers

You can specify default headers and query parameters in your client configuration, and they will be included in the connection request message.

[source,xml,linenums]
----
<websocket:config ​name​=​"wsClient"​> ​
    <websocket:connection>
    ​   <websocket:client-settings ​host​=​"localhost" port​=​"${listenerPort}"​ ​basePath​=​"/ws"​>
    ​       <websocket:default-headers>
                ​<websocket:header ​key​=​"myFirstDefaultHeader"​ v​alue​=​"defaultHeader1" />
                ​<websocket:header ​key​=​"mySecondDefaultHeader"​ v​alue​=​"defaultHeader2" />
            ​</websocket:default-headers>
            ​<websocket:default-query-params>
                ​<websocket:query-param ​key​=​"myFirstDefaultQueryParam" value="query1" />
                ​<websocket:query-param ​key​=​"mySecondDefaultQueryParam" value="query2" />
            ​</websocket:default-query-params>
    ​   </websocket:client-settings>
    </websocket:connection>
</websocket:config>
----

You can also choose to add headers or query parameters to your connect operation and they will be sent along with the default headers and parameters in the request to establish the connection.

[source,xml,linenums]
----
<flow="connectToWebSocketFlow">
    <websocket:open-outbound-socket path="/chat" config-ref="wsClient">
            <websocket:headers><![CDATA[
                    #[
                        {
                            chatAlias: 'Captain Marvel'
                        }
                    ]
                ]]>
            </websocket:headers>
            <websocket:query-params><![CDATA[
                    #[
                        {
                            theme: 'USA'
                        }
                    ]
                ]]>
            </websocket:query-params>
    </websocket:open-outbound-socket>
</flow>
----

=== Client Timeouts

Just like with inbound connections, it's a good practice to set a timeout to automatically close idle outbound connections.

The following example shows how to use the `<websocket:client-settings>` to configure a one hour idle sockets timeout:

[source,xml,linenums]
----
<websocket:config ​name​=​"wsServer"​> ​
    <websocket:connection>
    ​   <websocket:client-settings ​host​=​"localhost" port​=​"${listenerPort}"​ ​basePath​=​"/ws"​ connectionIdleTimeout="1" connectionIdleTimeoutUnit="HOURS" />
    </websocket:connection>
</websocket:config>
----

By default, outbound sockets have no idle timeout. However, the remote service to which they connect is likely to have one.

== Combined Client/Server Configuration [[combined-configuration]]

If you want the app to listen for incoming connections and issue requests to external services, you can configure the client and server together.

[source,xml,linenums]
----
<http:listener-config name="httpListenerConfig" basePath="/willBeOverriddenByWSConfig">
   <http:listener-connection host="0.0.0.0" port="${listenerPort}" />
</http:listener-config>

<websocket:config ​name​=​"ws"​> ​
    <websocket:connection>
    ​   <websocket:server-settings ​listenerConfig​=​"httpListenerConfig" listenerBasePath​=​"/ws"​ />
    ​   <websocket:client-settings ​host​=​"localhost" port​=​"80"​ ​basePath​=​"/ws"​ />
    </websocket:connection>
</websocket:config>
----

Now we can reference this configuration from both Inbound and Outbound sockets.

[source,xml,linenums]
----
<flow="acceptIncomingMessagesFlow">
    <websocket:inbound-listener ​path​=​"/quotes"​ ​config-ref​=​"ws"​ />
    <logger info="INFO" message="I listen for incoming messages at '/quotes'!"/>
</flow>

<flow="connectToWebSocketFlow">
    <websocket:open-outbound-socket path="/chat" config-ref="ws"/>
    <logger info="INFO" message="I open a connection to an external service listening at path '/chat'!"/>
</flow>
----

=== TLS Configuration

TLS (Transport Layer Security) enables client/server applications to communicate through a secure channele and prevent attackers from eavesdropping or tampering with the transmitted data.

With the WebSocket server, TLS configuration is inherited from the referenced HTTP Listener configuration. To configure TLS on a WebSocket listener, point to a <http:listener-config> with TLS configured.

You must first set up your Truststore if your application will connect to external services, or Keystore if your application will listen for incoming connections, or you can set up both.

In the following example, our WebSocket Server will inherit TLS configuration from the HTTP Listener, which will in turn reference a <tls:context> to configure a key-store.

[source,xml,linenums]
----
<tls:context name="listenerTlsContext" >
    <tls:key-store path="tls/muleKeystore" keyPassword="mulepassword" password="mulepassword" alias="muleserver" />
</tls:context>

<http:listener-config name="listenerTlsConfig">
    <http:listener-connection protocol="HTTPS" host="localhost" port="${listenerPort}" tlsContext="listenerTlsContext"/>
</http:listener-config>

<websocket:config name="requestConfigWithCertificate">
    <websocket:connection>
        <websocket:server-settings listenerConfig="listenerTlsConfig" listenerBasePath="/"/>
    </websocket:connection>
</websocket:config>
----

In case of a WebSocket Client, you can set up a Truststore by directly referencing the <tls:context> in the tlsConfig property.

[source,xml,linenums]
----
<tls:context name="requestTlsContextWithCertificate" >
    <tls:trust-store path="tls/trustStore" password="mulepassword" />
</tls:context>

<websocket:config name="requestConfigWithCertificate">
    <websocket:connection>
        <websocket:client-settings host="localhost" port="${listenerPort}" tlsContext="requestTlsContextWithCertificate" protocol="WSS"/>
    </websocket:connection>
</websocket:config>
----

The protocol parameter is optional and defaults to WS (insecure). If set to `WSS`, then SSL will be enabled in the connection. If a `<tls:content>` was specified, then that configuration will be used to create the SSL session. Otherwise, default settings will be used.

== Next

Now that you have completed configuration, you can try out the WebSocket xref:websockets/websocket-connector-examples.adoc[Examples].

== See Also

* https://forums.mulesoft.com[MuleSoft Forum]
* https://support.mulesoft.com/s/knowledge[Knowledge Base Articles]
* xref:4.1@mule-runtime::tls-configuration.adoc[Configure TLS with Keystores and Truststores]
* xref:http/websockets-connector-get-started.adoc[About WebSocket Connector]
* xref:http/websockets-connector-cloudhub.adoc[WebSocket Connector in VPC]
* xref:websockets/websockets-connector-xml-maven.adoc[WebSockets Xml Maven]
