= WebSocket Trigger Details - Mule 4
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../../assets/images/

WebSocket Connector supports the following triggers for inbound and outbound WebSockets:

[%header,cols="20a,80a"]
|===
|WebSocket Type | Supported Triggers
|Inbound (server) a|

* <<inbound-listener-trigger,Inbound Listener>>
* <<on-inbound-connection-trigger,On Inbound Connection>>
* <<on-websocket-close-trigger, On Socket Close>>
|Outbound (client) a|

* <<on-websocket-close-trigger,On Socket Close>>
* <<outbound-listener-trigger, Outbound Listener>>
|===

== Inbound Listener Trigger [[inbound-listener-trigger]]

Use the `<websocket:inbound-listener>` element to represent an inbound WebSocket endpoint to which clients can connect. By hitting this endpoint, external clients establish a WebSocket connection and trigger the associated flow each time they send a message.

You can use the `defaultGroups` parameter to specify the default groups to which the inbound WebSocket subscribes. When you specify default groups, the WebSocket automatically receives and processes broadcast operations that are performed on these groups.

For more information about WebSocket groups, see <<websocket/websocket-connector-management.adoc#manage-groups,Manage WebSocket Groups>>.

=== Sending Responses

Because a WebSocket is full-duplex, the Inbound Listener doesn't automatically send a response. Depending on your use case, you might want to process the messages without sending a response or only send a response in certain cases.

To send a response, use the <<websocket/websocket-connector-operations.adoc#send-operation,Send operation>>.

=== Example

In the following example:

* The flow named `sendFriendlyMessageFlow` creates an outbound WebSocket and sends the message `Hi! How are you?`to the inbound endpoint.
* The flow named `onIncomingMessageFlow` contains an Inbound Listener that listens for messages on path `/chat/hello`. Each time it receives a message, the flow sends the response `I'm fine, thank you!`.

[source,xml,linenums]
----
<
<flow name="sendFriendlyMessageFlow">
    <websocket:open-outbound-socket path="/chat" config-ref="ws" />
    <websocket:send doc:name="SendMessage" socketId="#[attributes.socketId]" config-ref="ws" >
        <websocket:content>#['Hi! How are you?']</websocket:content>
    </websocket:send>
</flow>
flow name="onIncomingMessageFlow">
    <websocket:inbound-listener ​path​=​"/chat"​ ​defaultGroups​=​"#[['AVENGERS', 'REVENGERS']]"​ ​config-ref​=​"ws"​ />
    <logger level="INFO" message="#['Received message ' ++ payload ++ ' from socket: ' ++ attributes.socketId]" />
    <websocket:send doc:name="SendResponse" socketId="#[attributes.socketId]" config-ref="ws" >
        <websocket:content>#['I'm fine, thank you!']</websocket:content>
    </websocket:send>
</flow>
----

=== Output

The Inbound Listener trigger returns:

* A message payload that contains the inbound message content.
* An object of type `InboundWebSocketAttributes` that contains the message attributes.

The message MIME type is obtained from the Content-Type header of the HTTP request. If the Content-Type header isn't set, the MIME type defaults to one of these values, depending on the protocol’s DATA frame type:

* For a binary DATA frame, the MIME type is application/octect-stream.
* For a text DATA frame, the MIME type is text/plain.

== On Inbound Connection Trigger [[on-inbound-connection-trigger]]

Use the `<websocket:on-inbound-connection>` element to trigger a flow each time an inbound WebSocket connection is established. You can use the associated flow to provide post-connect tasks such as logging or subscribing the WebSocket to a group.

The `<websocket:on-inbound-connection>` element also:

* Keeps track of the generated WebSocket Ids so that the app can use them later.
* Establishes a validation point at which a WebSocket can be rejected before it the app can use it.

You can only have one On Inbound Connection trigger for a given path. Also, you must configure a matching <<inbound-listener-trigger,Inbound Listener>> for the path.

=== Sending Responses

The flow associated with the On Inbound Connection trigger is triggered asynchronously. Because the flow is invoked after the socket is established, the socket might be broadcasting or receiving messages. The messages are queued and not delivered to the associated flow until the event triggered by the On Inbound Connection trigger completes. If the event fails, all queued messages are discarded and the connection is dropped.

=== Example

The following flow validates attributes from the originating request and closes the connection if the validation doesn't pass:

[source,xml,linenums]
----
<flow name="onNewInboundConnection">
    <websocket:on-inbound-connection doc:name="On Inbound Connection" config-ref="WebSockets_Config" path="/chat"/>
    <choice doc:name="Choice" >
        <when expression="#[contains(attributes.headers.alias, 'admin')]">
            <websocket:close socketId="#[attributes.socketId]" reason="Cannot impersonate the admin" config-ref="WebSockets_Config"/>
        </when>
        <otherwise >
            <logger level="INFO" doc:name="Logger" message="Successfully connected to WebSocket #[attributes.socketId]" />
        </otherwise>
    </choice>
</flow>
<flow name="chat">
    <websocket:inbound-listener doc:name="Inbound listener" path="/chat" config-ref="WebSockets_Config"/>
    <logger level="INFO" doc:name="Logger" message="#['Received message' ++ payload]"/>
</flow>
----

=== Output

The On Inbound Connection trigger consists of:

* An empty message payload.
* An object of type `InboundWebSocketAttributes` that contains the message attributes.

== On Socket Close Trigger [[on-websocket-close-trigger]]

Use the `<websocket:on-socket-close` trigger to perform cleanup tasks such as logging and updating the app state.

The flow associated with Socket Close is triggered asynchronously, after the WebSocket is closed. Therefore, the triggered flow cannot send messages through the WebSocket.

=== Example

The following example closes the WebSocket connection identified by the `ws` socket ID:

----
<websocket:on-connection-closed path="/ws/*" config-ref="ws" />
----

=== Output

The On Socket close trigger returns:

* An empty message payload.
* An object of type `WebSocketAttributes` that contains the message attributes.

== Outbound Listener Trigger [[outbound-listener-trigger]]

Use the `<websocket:outbound-listener>` trigger to send return messages when a message is received on an outbound endpoint.
*Is there any other reason to use this trigger?*

The flow associated with the Outbound Listener Trigger is triggered asynchronously, after the outbound WebSocket receives a message. Because a WebSocket is full-duplex, the Outbound Listener doesn't automatically send a response. Depending on your use case, you might want to process the messages without sending a response, or only send responses in certain cases.

To send a response, use the <<websocket/websocket-connector-operations.adoc#send-operation,WebSocket Send operation>>.

=== Example

We need a better example than what's in the tech reference. It would be good to show a flow that sends a message.

=== Output

The Outbound Listener trigger returns:

* A message payload that contains the outbound message content.
* An object of type `WebSocketAttributes` that contains the message attributes.

The message MIME type is obtained from the Content-Type header of the HTTP request. If the Content-Type header isn't set, the MIME type defaults to one of these values, depending on the protocol’s DATA frame type:

* For a binary DATA frame, the MIME type is application/octect-stream.
* For a text DATA frame, the MIME type is text/plain.
