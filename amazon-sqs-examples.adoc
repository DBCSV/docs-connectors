= Amazon SQS Examples - Mule 4
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../../assets/images/

The common use cases for the Amazon SQS Connector are to send a message along with metadata to an Amazon SQS queue and then receive it from the queue. This can be split into the following two flows:

* Send message along with metadata, and then get the count of the messages in the queue to validate that the message has been sent.

* Receive the message and log the message body.

== Send and Receive a Message

Send a message along with metadata to an Amazon SQS queue and receive the message from the queue.
For this example to work in Anypoint Studio, you must provide Amazon Web Services credentials. 

image::amazon/amazon-sqs-02.png[]

=== Create a Flow to Send a Message

. Create a new Mule project in Studio.
. Drag an *HTTP Listener* operation into the canvas, and select it to open the properties editor.
. Add a new HTTP Listener configuration global element:
.. In *General Settings*, click *+*.
.. Configure the following HTTP parameters, retain the default values for the other fields, and click *OK*.
+
[%header,cols="30s,70a"]
|===
|Field |Value
|Name |HTTP_Listener_Configuration
|Host |127.0.0.1
|Port |8081
|===
+
.. Reference the HTTP Listener Configuration global element. In the General tab, specify the `/` Path.
. Add a *Transform Message* component to attach the metadata:
+
image::amazon/amazon-sqs-03.png[]
+
[source,xml,linenums]
----
%dw 2.0
output application/java
---
{
	delaySeconds: 0,
	body: "Hello World",
	messageAttributes: {
		"AccountId": {
			"stringValue" : "000123456",
			"dataType" : "String.AccountId"
		} as Object {
			class: "org.mule.extension.sqs.api.model.MessageAttributeValue"
		},
		"NumberId": {
			"stringValue" : "230.000000000000000001",
			"dataType" : "Number"
		} as Object {
			class : "org.mule.extension.sqs.api.model.MessageAttributeValue"
		}
	} as Object {
		class: "java.util.HashMap"
	}
} as Object {
	class: "org.mule.extension.sqs.api.model.Message"
}
----
+
. Drag an Amazon SQS connector Send message operation into the flow, and double-click the connector to open its properties editor.
. In *Basic Settings* on the right side of the field Extension configuration click the plus icon and add values for *Access Key*, *Secret Key*, and *Queue Name*.
. Configure the remaining parameters of the connector.
+
image::amazon/amazon-sqs-04.png[]
+
. Add a Logger to display the response in the Studio console.
+
image::amazon/amazon-sqs-05.png[]
+
. Add another *Amazon SQS Connector* > *Get* to get an approximate number of messages for the number of the messages in the queue.
+
image::amazon/amazon-sqs-06.png[]

. Add a Logger to print the number in the Studio console.
+
image::amazon/amazon-sqs-05.png[]


=== Create a Flow to Receive a Message

This completes the first part of the use case. Now create another flow to receive message and log them before deleting them from the queue.

. Drag an Amazon SQS connector Receivemessages operation into the flow, and double-click the connector to open its properties editor.
+
image::amazon/amazon-sqs-07.png[Receivemessage operation]
. Add a Logger to print the message in the Mule Console:
+
image::amazon/amazon-sqs-05.png[Logger]

== Use Case: XML Code


[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" 
xmlns:http="http://www.mulesoft.org/schema/mule/http" 
xmlns:sqs="http://www.mulesoft.org/schema/mule/sqs" 
xmlns="http://www.mulesoft.org/schema/mule/core" 
xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" 
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core 
http://www.mulesoft.org/schema/mule/core/current/mule.xsd 
http://www.mulesoft.org/schema/mule/sqs 
http://www.mulesoft.org/schema/mule/sqs/current/mule-sqs.xsd 
http://www.mulesoft.org/schema/mule/http 
http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd 
http://www.mulesoft.org/schema/mule/ee/core 
http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
  <configuration-properties file="mule-artifact.properties"/>
  <sqs:config name="Amazon_SQS_Configuration" doc:name="Amazon SQS Configuration" >
    <sqs:basic-connection 
    	accessKey="${sqs.accessKey}" 
	secretKey="${sqs.secretKey}" 
	defaultQueueName="${sqs.queueName}"/>
  </sqs:config>
  <http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config" >
    <http:listener-connection host="0.0.0.0" port="8081"/>
  </http:listener-config>
  <flow name="sqs-send-message-operation-demo-flow">
    <http:listener config-ref="HTTP_Listener_config" path="/" doc:name="Listener" />
    <ee:transform doc:name="Transform Message" >
      <ee:message>
        <ee:set-payload><![CDATA[%dw 2.0
output application/java
---
{
	delaySeconds: 0,
	body: "Hello World",
	messageAttributes: {
		"AccountId": {
			"stringValue" : "000123456",
			"dataType" : "String.AccountId"
		} as Object {
			class: "org.mule.extension.sqs.api.model.MessageAttributeValue"
		},
		"NumberId": {
			"stringValue" : "230.000000000000000001",
			"dataType" : "Number"
		} as Object {
			class : "org.mule.extension.sqs.api.model.MessageAttributeValue"
		}
	} as Object {
		class: "java.util.HashMap"
	}
} as Object {
	class: "org.mule.extension.sqs.api.model.Message"
}]]></ee:set-payload>
      </ee:message>
    </ee:transform>
    <sqs:send-message 
    	config-ref="Amazon_SQS_Configuration" 
	doc:name="Send message"  
	message="#[payload]"/>
    <logger level="INFO" doc:name="Logger" message="#[payload]"/>
    <sqs:get-approximate-number-of-messages 
    	config-ref="Amazon_SQS_Configuration" 
	doc:name="Get approximate number of messages" 
    queueUrl="queueURL"/>
    <logger level="INFO" doc:name="Logger" message="#[payload]"/>
  </flow>
  <flow name="sqs-receive-delete-message-operations-demo-flow">
    <sqs:receivemessages 
    	config-ref="Amazon_SQS_Configuration" 
	doc:name="Receivemessages" 
	queueUrl="queueURL"/>
    <logger 
    	level="INFO" 
	doc:name="Logger" 
	message="#[payload]"/>
  </flow>
</mule>
----

== See Also

* https://forums.mulesoft.com[MuleSoft Forum]
* http://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/credentials.html#using-the-default-credential-provider-chain[Amazon Default Provider Credential Chain]
